# arty_e310

-----------------------------
Prerequisites:
-----------------------------
For the pre-built example FPGA image, you just need Vivado.
To build the custom image, you need Vivado and the SiFive RISC-V toolchain installed.

-----------------------------
Documentation:
-----------------------------

  Arty A7 comes in two FPGA variants: Arty A7-35T features Xilinx XC7A35TICSG324-1L. Arty A7-100T features the larger Xilinx XC7A100TCSG324-1

-----------------------------
Loading the pre-built example FPGA Image (blink):
-----------------------------

  Plug Arty board into USB cable.
  Make sure the Virtual Machine has control of the device "Digilent USB Device" and USB device is connected (instructions above)
  (If you unplug the Arty and plug it back in you may need to re-enable VM control of the USB device)
  
  Run Vivado -> Flow -> Open Hardware Manager -> Open Target -> AutoConnect - should see Xilinx_tcf/Digilent/<ID Number>    
  Right-click on xc7a35t_0, select ”Add Configuration Memory Device”
  Seach for "mt25ql128" - will show image n25q128-3.3v
  Press "Yes" when it asks if you want to program the Configuration Memory Device
  Select freedom-e310-arty-1-0-2.mcs  (Instructions to download:   SiFive Freedom E310 Arty FPGA Dev Kit Getting Started Guide - Chapter 3)
  Leave defaults - hit okay to begin programming
  You should see the red and green LEDs on the USB side of the board light up.
  (Don't switch away from VM focus during this or it may error out)
  You should see a "programming successful" message.
  After resetting the board (re-plugging the cable may be required) you should see the LED blink program running.   
    

-----------------------------
Creating the RTL (from Chisel source) and building the FPGA Image File (Configuration Memory File) from source using Windows Linux Subsystem w' Ubuntu:
-----------------------------

Clone SiFive Freedom E310 github repository (Using Cygwin bash shell):
  cd ~/cygwin
  git clone http://github.com/sifive/freedom
  cd freedom
  #Run this command to update subrepositories used by freedom
  git submodule update --init --recursive
  
 Build the RTL and MCS (make sure you do these in order):
  The Makefile corresponding to the Freedom E300 Arty FPGA Dev Kit is Makefile.e300artydevkit and it consists of two main targets:

  #verilog: to compile the Chisel source files into Verilog source files.  (You must have the RISC-V toolchain installed to do this - see RISCV_Setup.txt)
  make -f Makefile.e300artydevkit verilog
  
  #mcs: to create a Configuration Memory File (.mcs) that can be programmed onto an Arty FPGA board.  (You must have Vivado *and* the RISC-V toolchain installed to do this - see Vivado_Setup.txt and RISCV_Setup.txt)
  make -f Makefile.e300artydevkit mcs
  
  (output files under builds/e300artydevkit/obj)


-----------------------------
Creating the RTL (from Chisel source) and building the FPGA Image File (Configuration Memory File) from source using Cygwin:
-----------------------------

Clone SiFive Freedom E310 github repository (Using Cygwin bash shell):
  cd ~/cygwin
  git clone http://github.com/sifive/freedom
  cd freedom
  #Run this command to update subrepositories used by freedom
  git submodule update --init --recursive
  
 Build the RTL and MCS (make sure you do these in order):
  The Makefile corresponding to the Freedom E300 Arty FPGA Dev Kit is Makefile.e300artydevkit and it consists of two main targets:

  #verilog: to compile the Chisel source files into Verilog source files.  (You must have the RISC-V toolchain installed to do this - see RISCV_Setup.txt)
  make -f Makefile.e300artydevkit verilog
  
  #mcs: to create a Configuration Memory File (.mcs) that can be programmed onto an Arty FPGA board.  (You must have Vivado *and* the RISC-V toolchain installed to do this - see Vivado_Setup.txt and RISCV_Setup.txt)

  make -f Makefile.e300artydevkit mcs
  
  (output files under builds/e300artydevkit/obj)


-----------------------------
Updating the RTL:
-----------------------------

cd to directory .../freedom
git pull


-----------------------------
Loading the custom-built FPGA Image (blink):
-----------------------------
Follow the instructions above for the example FPGA image, except select .../freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.mcs instead.
After resetting the board (re-plugging the cable may be required) you should see the LED blink program running.



-----------------------------
Connecting to the Arty (through the USB port) via terminal program:
-----------------------------
On the VM:
  
  sudo apt install screen (first time setup)
  
  sudo screen /dev/ttyUSB2 115200
  (115200 for the precompiled image - 57600 for the compiled freedom image - https://forums.sifive.com/t/printing-over-uart-broken/1322) 
  
  Press Reset on the Arty
  You should see text like that shown in the Getting Started Guide

Issue - currently the output text is flaky (using both images), and varies from reset to reset.  Have seen similar complaints in forum.  Could be a an actual protocol issue, or perhaps an issue in translation between host and VM control.


Running the software debugger with Blink (via the Olimex):
-----------------------------
  In case you have to install the FTDI drivers, but in Ubuntu they should be included in the kernel by default:  https://www.ftdichip.com/Support/Documents/AppNotes/AN_220_FTDI_Drivers_Installation_Guide_for_Linux.pdf
  
  Make sure the Virtual Machine has control of the device "Olimex Ltd. OpenOCD JTAG ARM-USB-TINY-H"  (Not "Olimex Ltd. ARM-USB-TINY-H JTAG interface").  If it's not there, then ensure the VM is started *before* the Olimex is connected to the host and try again.
  
  Connect the Olimex to the Arty board according to the diagram and picture on pages 4/5 of the Getting Started Guide
  Connect the Olimex to a USB cable, and connect to the host machine.
  Once you plug the Olimex into the host *and* into the Arty, program execution will halt.
  
  <wip>
 